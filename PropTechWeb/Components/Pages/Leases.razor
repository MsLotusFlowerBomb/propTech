@page "/leases"
@using PropTechWeb.Models
@using PropTechWeb.Services
@inject DataStore DataStore
@inject PropertyManager Manager
@rendermode InteractiveServer

<PageTitle>Leases â€” PropMate AI</PageTitle>

<h2>ðŸ“„ Leases</h2>
<p>Create lease agreements with AI-generated clauses compliant with the SA Rental Housing Act.</p>

<h4>Create New Lease</h4>
<div class="row mb-4">
    <div class="col-md-4">
        <label class="form-label">Tenant</label>
        <select class="form-select" @bind="_selectedTenantId">
            <option value="">â€” Select Tenant â€”</option>
            @foreach (var t in DataStore.Tenants)
            {
                <option value="@t.Id">@t.FullName</option>
            }
        </select>
    </div>
    <div class="col-md-4">
        <label class="form-label">Property</label>
        <select class="form-select" @bind="_selectedPropertyId">
            <option value="">â€” Select Property â€”</option>
            @foreach (var p in DataStore.Properties)
            {
                <option value="@p.Id">@p.Address (R @p.MonthlyRent.ToString("N0"))</option>
            }
        </select>
    </div>
    <div class="col-md-4 d-flex align-items-end">
        <button class="btn btn-success" @onclick="CreateLease" disabled="@_isCreating">
            @if (_isCreating)
            {
                <span class="spinner-border spinner-border-sm" role="status"></span>
                <span> Creating...</span>
            }
            else
            {
                <span>Create Lease with AI Clause</span>
            }
        </button>
    </div>
</div>

@if (!string.IsNullOrEmpty(_errorMessage))
{
    <div class="alert alert-danger">@_errorMessage</div>
}

@if (_aiClause != null)
{
    <div class="card border-success mb-3">
        <div class="card-header">ðŸ¤– AI-Generated Lease Clause</div>
        <div class="card-body">
            <p>@_aiClause</p>
        </div>
    </div>
}

<h4>Active Leases</h4>
<table class="table table-striped">
    <thead>
        <tr>
            <th>Lease ID</th>
            <th>Tenant</th>
            <th>Property</th>
            <th>Monthly Rent</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var lease in DataStore.Leases)
        {
            <tr>
                <td><code>@lease.Id[..8]...</code></td>
                <td>@lease.Lessee.FullName</td>
                <td>@lease.LeasedProperty.Address</td>
                <td>R @lease.MonthlyRent.ToString("N0")</td>
            </tr>
        }
        @if (DataStore.Leases.Count == 0)
        {
            <tr><td colspan="4" class="text-muted">No leases created yet.</td></tr>
        }
    </tbody>
</table>

@code {
    private string _selectedTenantId = "";
    private string _selectedPropertyId = "";
    private string? _aiClause;
    private string? _errorMessage;
    private bool _isCreating;

    private async Task CreateLease()
    {
        _errorMessage = null;
        _aiClause = null;

        if (string.IsNullOrWhiteSpace(_selectedTenantId) || string.IsNullOrWhiteSpace(_selectedPropertyId))
        {
            _errorMessage = "Please select both a tenant and a property.";
            return;
        }

        try
        {
            _isCreating = true;
            var (_, clause) = await Manager.CreateLeaseAsync(_selectedTenantId, _selectedPropertyId);
            _aiClause = clause;
            _selectedTenantId = "";
            _selectedPropertyId = "";
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isCreating = false;
        }
    }
}
